name: Build All Platforms

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      
      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked
      
      - name: Build for macOS ARM64
        run: cd src-tauri && cargo tauri build --target aarch64-apple-darwin --bundles app,dmg
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: src-tauri/target/aarch64-apple-darwin/release/bundle/

  build-macos-intel:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      
      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked
      
      - name: Build for macOS Intel
        run: cd src-tauri && cargo tauri build --target x86_64-apple-darwin --bundles app,dmg
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: src-tauri/target/x86_64-apple-darwin/release/bundle/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      
      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked
      
      - name: Build for Windows
        run: cd src-tauri && cargo tauri build --target x86_64-pc-windows-msvc --bundles msi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/

  build-ubuntu:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu
      
      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked
      
      - name: Build for Ubuntu/Debian (DEB and AppImage)
        run: cd src-tauri && cargo tauri build --target x86_64-unknown-linux-gnu --bundles deb,appimage
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/

  release:
    needs: [build-macos-arm, build-macos-intel, build-windows, build-ubuntu]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Download macOS ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64
          path: artifacts/macos-arm64
      
      - name: Download macOS Intel artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64
          path: artifacts/macos-x86_64
      
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-x86_64
          path: artifacts/windows-x86_64
      
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-x86_64
          path: artifacts/linux-x86_64
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Rodrigolab's Flow Cytometry Analyzer v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Rodrigolab's Flow Cytometry Analyzer v${{ steps.get_version.outputs.VERSION }}
            
            ### Downloads
            
            **macOS (Apple Silicon)**
            - App Bundle: Download from artifacts below
            - DMG: Download from artifacts below
            
            **macOS (Intel)**
            - App Bundle: Download from artifacts below
            - DMG: Download from artifacts below
            
            **Windows**
            - MSI Installer: Download from artifacts below
            
            **Linux (Ubuntu/Debian)**
            - DEB Package: Download from artifacts below
            - AppImage: Download from artifacts below
            
            ### Installation Instructions
            
            - **macOS**: Open the DMG file and drag the app to Applications
            - **Windows**: Run the MSI installer
            - **Linux**: Install the DEB package with `sudo dpkg -i <package.deb>` or run the AppImage directly
            
            ### Changes
            See the commit history for details.
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
          tag_name: ${{ github.ref_name }}

